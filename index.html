<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#3B82F6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Schone Zwaan" />
    <link rel="manifest" href="/manifest.json" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/icons/icon-192.png"
    />
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png" />
    <title>Schone Zwaan</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.2s ease-out;
      }
      @keyframes swanBounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-20px);
        }
      }
      .swan-bounce {
        animation: swanBounce 1s ease-in-out infinite;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.2s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;

      // ============================================================================
      // CONFIG
      // ============================================================================

      const firebaseConfigDev = {
        apiKey: "AIzaSyBWQt7JoTp9xpMbWlFqDZXGu99hbbo6KNQ",
        authDomain: "schoonmaak-tracker-dev.firebaseapp.com",
        databaseURL:
          "https://schoonmaak-tracker-dev-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "schoonmaak-tracker-dev",
        storageBucket: "schoonmaak-tracker-dev.firebasestorage.app",
        messagingSenderId: "683196128061",
        appId: "1:683196128061:web:713774020f21298a378354",
      };

      const firebaseConfigProd = {
        apiKey: "AIzaSyCy18JxgaB2P-mL-WeKu36XSzykhYi-ypY",
        authDomain: "schoonmaak-tracker.firebaseapp.com",
        databaseURL:
          "https://schoonmaak-tracker-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "schoonmaak-tracker",
        storageBucket: "schoonmaak-tracker.firebasestorage.app",
        messagingSenderId: "276714806125",
        appId: "1:276714806125:web:4394e4d2412905c81e9864",
      };

      const isDevelopment =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1" ||
        window.location.hostname === "192.168.0.188";

      const firebaseConfig = isDevelopment
        ? firebaseConfigDev
        : firebaseConfigProd;

      console.log(
        `üî• Firebase Environment: ${
          isDevelopment ? "DEVELOPMENT" : "PRODUCTION"
        }`
      );
      console.log(`üì¶ Project: ${firebaseConfig.projectId}`);

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const ACTIVITY_LIMIT = 200;
      const MS_PER_DAY = 86400000;

      // ============================================================================
      // ICONS
      // ============================================================================

      const Icon = ({ d, size = 24, className = "" }) => (
        <svg
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          {Array.isArray(d) ? (
            d.map((path, i) => <path key={i} d={path} />)
          ) : (
            <path d={d} />
          )}
        </svg>
      );

      const Icons = {
        Check: (props) => <Icon d="M20 6L9 17l-5-5" {...props} />,
        X: (props) => <Icon d={["M18 6L6 18", "M6 6l12 12"]} {...props} />,
        ChevronLeft: (props) => <Icon d="M15 18l-6-6 6-6" {...props} />,
        ChevronRight: (props) => <Icon d="M9 18l6-6-6-6" {...props} />,
        ChevronDown: (props) => <Icon d="M6 9l6 6 6-6" {...props} />,
        Settings: (props) => (
          <Icon
            d={[
              "M12 15a3 3 0 100-6 3 3 0 000 6z",
              "M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z",
            ]}
            {...props}
          />
        ),
        Trophy: (props) => (
          <Icon
            d={[
              "M6 9H4.5a2.5 2.5 0 010-5H6",
              "M18 9h1.5a2.5 2.5 0 000-5H18",
              "M4 22h16",
              "M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22",
              "M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22",
              "M18 2H6v7a6 6 0 0012 0V2z",
            ]}
            {...props}
          />
        ),
        Activity: (props) => <Icon d="M22 12h-4l-3 9L9 3l-3 9H2" {...props} />,
        Clock: (props) => (
          <Icon
            d={["M12 22a10 10 0 100-20 10 10 0 000 20z", "M12 6v6l4 2"]}
            {...props}
          />
        ),
        Plus: (props) => <Icon d={["M12 5v14", "M5 12h14"]} {...props} />,
      };

      // ============================================================================
      // UTILITIES
      // ============================================================================

      const getWeekNumber = (date) => {
        const target = new Date(date.valueOf());
        const dayNr = (date.getDay() + 6) % 7;
        target.setDate(target.getDate() - dayNr + 3);
        const jan4 = new Date(target.getFullYear(), 0, 4);
        const dayDiff = (target - jan4) / MS_PER_DAY;
        return 1 + Math.ceil(dayDiff / 7);
      };

      const getWeekDateRange = (weekNum, year) => {
        const jan4 = new Date(year, 0, 4);
        const jan4Day = jan4.getDay() || 7;
        const week1Monday = new Date(jan4);
        week1Monday.setDate(jan4.getDate() - jan4Day + 1);
        const monday = new Date(week1Monday);
        monday.setDate(week1Monday.getDate() + (weekNum - 1) * 7);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return `${monday.getDate()}/${
          monday.getMonth() + 1
        } - ${sunday.getDate()}/${sunday.getMonth() + 1}`;
      };

      const formatTimestamp = (ts) => {
        const date = new Date(ts);
        const diff = Date.now() - ts;
        const mins = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / MS_PER_DAY);
        if (mins < 1) return "Zojuist";
        if (mins < 60) return `${mins} min geleden`;
        if (hours < 24) return `${hours} uur geleden`;
        if (days < 7) return `${days} dag${days !== 1 ? "en" : ""} geleden`;
        return date.toLocaleDateString("nl-NL", {
          day: "numeric",
          month: "short",
        });
      };

      const toast = (msg, type = "error") => {
        const id = `toast-${Date.now()}`;
        const bg =
          type === "error"
            ? "bg-red-500"
            : type === "warning"
            ? "bg-orange-500"
            : "bg-green-500";
        const el = document.createElement("div");
        el.id = id;
        el.className = `fixed bottom-4 right-4 ${bg} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
        el.innerHTML = `<div class="flex items-center gap-3"><span>${msg}</span><button onclick="this.parentElement.parentElement.remove()" class="hover:bg-white hover:bg-opacity-20 rounded p-1">‚úï</button></div>`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 5000);
      };

      // ============================================================================
      // COMPONENTS
      // ============================================================================

      const UserPicker = ({ people, onSelect }) => {
        const [showInstallGuide, setShowInstallGuide] = useState(false);

        const isStandalone =
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone;

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <div className="max-w-sm w-full space-y-4">
              <div className="bg-white rounded-2xl shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-2 text-center">
                  Wie ben jij?
                </h2>
                <p className="text-gray-600 text-center mb-6">
                  Selecteer je naam
                </p>
                <div className="space-y-3">
                  {people.map((name) => (
                    <button
                      key={name}
                      onClick={() => onSelect(name)}
                      className="w-full p-4 rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all font-medium text-gray-700 hover:text-blue-700"
                    >
                      {name}
                    </button>
                  ))}
                </div>
              </div>

              {!isStandalone && (
                <button
                  onClick={() => setShowInstallGuide(true)}
                  className="w-full bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2"
                >
                  <span className="text-xl">üì±</span>
                  <span className="font-medium">
                    Installeer app op beginscherm
                  </span>
                </button>
              )}

              {/* Install Guide Modal */}
              {showInstallGuide && (
                <>
                  <div
                    className="fixed inset-0 bg-black bg-opacity-50 z-40"
                    onClick={() => setShowInstallGuide(false)}
                  />
                  <div className="fixed inset-0 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full max-h-[90vh] overflow-y-auto animate-fadeIn">
                      <div className="flex justify-between items-start mb-4">
                        <h2 className="text-xl font-bold text-gray-800">
                          Installeer op beginscherm
                        </h2>
                        <button
                          onClick={() => setShowInstallGuide(false)}
                          className="p-1 hover:bg-gray-100 rounded-lg transition-colors"
                        >
                          <Icons.X size={20} />
                        </button>
                      </div>

                      <div className="space-y-4">
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                          <p className="text-sm text-blue-800 font-medium mb-1">
                            iOS Safari instructies:
                          </p>
                          <ol className="text-sm text-blue-700 space-y-2 list-decimal list-inside">
                            <li>
                              Tik op het <strong>"Deel"</strong> icoontje
                              onderaan (vierkant met pijl omhoog)
                            </li>
                            <li>
                              Scroll naar beneden en kies{" "}
                              <strong>"Zet op beginscherm"</strong>
                            </li>
                            <li>
                              Tik op <strong>"Voeg toe"</strong>
                            </li>
                          </ol>
                        </div>

                        <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                          <p className="text-sm text-green-800 font-medium mb-1">
                            Android Chrome instructies:
                          </p>
                          <ol className="text-sm text-green-700 space-y-2 list-decimal list-inside">
                            <li>
                              Tik op het <strong>menu</strong> icoontje (3
                              puntjes rechtsboven)
                            </li>
                            <li>
                              Selecteer{" "}
                              <strong>"Toevoegen aan startscherm"</strong>
                            </li>
                            <li>
                              Tik op <strong>"Toevoegen"</strong>
                            </li>
                          </ol>
                        </div>

                        <div className="text-center pt-2">
                          <button
                            onClick={() => setShowInstallGuide(false)}
                            className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 p-3 rounded-xl font-medium transition-colors"
                          >
                            Begrepen
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      };

      const ConfirmDialog = ({
        isOpen,
        title,
        message,
        onConfirm,
        onCancel,
        confirmText = "Bevestig",
        cancelText = "Annuleer",
      }) => {
        if (!isOpen) return null;
        return (
          <>
            <div
              className="fixed inset-0 bg-black bg-opacity-50 z-40"
              onClick={onCancel}
            />
            <div className="fixed inset-0 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full animate-fadeIn">
                <h3 className="text-xl font-bold text-gray-800 mb-2">
                  {title}
                </h3>
                <p className="text-gray-600 mb-6">{message}</p>
                <div className="flex gap-3">
                  <button
                    onClick={onCancel}
                    className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 p-3 rounded-xl font-medium transition-colors"
                  >
                    {cancelText}
                  </button>
                  <button
                    onClick={onConfirm}
                    className="flex-1 bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl font-medium transition-colors"
                  >
                    {confirmText}
                  </button>
                </div>
              </div>
            </div>
          </>
        );
      };

      // ============================================================================
      // MAIN APP
      // ============================================================================

      function App() {
        const [user, setUser] = useState(
          localStorage.getItem("currentUser") || ""
        );
        const [view, setView] = useState("tracker");

        // Firebase state
        const [config, setConfig] = useState(null);
        const [currentTasks, setCurrentTasks] = useState({});
        const [lastTasks, setLastTasks] = useState({});
        const [leaderboard, setLeaderboard] = useState({});
        const [dishwasherLogs, setDishwasherLogs] = useState([]);
        const [activity, setActivity] = useState([]);

        // UI state
        const [showDishwasherConfirm, setShowDishwasherConfirm] =
          useState(false);
        const [loading, setLoading] = useState(true);

        const now = new Date();
        const currentWeek = getWeekNumber(now);
        const currentYear = now.getFullYear();

        // ============================================================================
        // FIREBASE SYNC
        // ============================================================================

        useEffect(() => {
          const refs = {
            config: db.ref("config"),
            currentTasks: db.ref("currentWeekTasks"),
            lastTasks: db.ref("lastWeekTasks"),
            leaderboard: db.ref("leaderboard"),
            dishwasher: db.ref("dishwasherLogs"),
            activity: db.ref("activity"),
          };

          refs.config.on("value", (snap) => {
            const data = snap.val();
            if (data) {
              // Ensure all required fields exist
              setConfig({
                currentWeek: data.currentWeek || currentWeek,
                lastWeek: data.lastWeek || null,
                people: data.people || [],
                tasks: data.tasks || [],
                rotationOffsets: data.rotationOffsets || {},
                dishwasherPoints: data.dishwasherPoints || 0.25,
              });
            } else {
              // Initialize default config if nothing exists
              const defaultConfig = {
                currentWeek: currentWeek,
                lastWeek: null,
                people: ["Sam", "Roel", "Stijn", "Tom", "Maxim"],
                tasks: [
                  {
                    id: "woonkamer",
                    name: "Woonkamer",
                    assignedPeople: ["Roel", "Stijn"],
                    points: 1.0,
                  },
                  {
                    id: "keuken",
                    name: "Keuken",
                    assignedPeople: ["Tom", "Maxim"],
                    points: 1.0,
                  },
                  {
                    id: "vuilnis",
                    name: "Doeken/Vuilnis",
                    assignedPeople: ["Sam"],
                    points: 1.0,
                  },
                ],
                rotationOffsets: {},
                dishwasherPoints: 0.25,
              };
              setConfig(defaultConfig);
              db.ref("config").set(defaultConfig);
            }
          });

          refs.currentTasks.on("value", (snap) =>
            setCurrentTasks(snap.val() || {})
          );
          refs.lastTasks.on("value", (snap) => setLastTasks(snap.val() || {}));
          refs.leaderboard.on("value", (snap) =>
            setLeaderboard(snap.val() || {})
          );
          refs.dishwasher.on("value", (snap) =>
            setDishwasherLogs(snap.val() || [])
          );
          refs.activity.on("value", (snap) => setActivity(snap.val() || []));

          setLoading(false);

          return () => Object.values(refs).forEach((ref) => ref.off());
        }, []);

        // ============================================================================
        // WEEK TRANSITION LOGIC
        // ============================================================================

        useEffect(() => {
          if (!config || loading) return;

          const needsTransition = config.currentWeek < currentWeek;

          if (needsTransition) {
            console.log("üîÑ Week transition detected", {
              from: config.currentWeek,
              to: currentWeek,
            });
            handleWeekTransition();
          }
        }, [config, currentWeek, loading]);

        const handleWeekTransition = async () => {
          try {
            // 1. Calculate dishwasher points for completed week (tasks already counted in real-time)
            const weekPoints = {};
            config.people.forEach((person) => {
              weekPoints[person] = { dishwasher: 0 };
            });

            // ONLY add dishwasher points (task points already added in real-time)
            dishwasherLogs
              .filter((log) => log.weekNumber === config.currentWeek)
              .forEach((log) => {
                if (weekPoints[log.user]) {
                  weekPoints[log.user].dishwasher += log.points;
                }
              });

            // 2. Update cumulative leaderboard (only dishwasher, tasks already counted)
            const newLeaderboard = { ...leaderboard };
            Object.entries(weekPoints).forEach(([person, points]) => {
              if (!newLeaderboard[person]) {
                newLeaderboard[person] = {
                  totalPoints: 0,
                  onTimePoints: 0,
                  latePoints: 0,
                  dishwasherPoints: 0,
                  dishwasherCount: 0,
                };
              }
              // Only add dishwasher points - task points were already added in real-time
              newLeaderboard[person].dishwasherPoints += points.dishwasher;
              newLeaderboard[person].totalPoints += points.dishwasher;
            });

            // Count dishwasher logs
            config.people.forEach((person) => {
              const count = dishwasherLogs.filter(
                (log) => log.user === person
              ).length;
              if (newLeaderboard[person]) {
                newLeaderboard[person].dishwasherCount = count;
              }
            });

            // 3. Move current tasks to last week
            await db.ref("lastWeekTasks").set(currentTasks);

            // 4. Clear current tasks
            const emptyTasks = {};
            config.tasks.forEach((task) => {
              emptyTasks[task.id] = false;
            });
            await db.ref("currentWeekTasks").set(emptyTasks);

            // 5. Update config
            await db.ref("config").update({
              currentWeek: currentWeek,
              lastWeek: config.currentWeek,
            });

            // 6. Save leaderboard
            await db.ref("leaderboard").set(newLeaderboard);

            // 7. Log activity
            logActivity(
              "systeem",
              "week automatisch overgegaan",
              `Week ${config.currentWeek} ‚Üí ${currentWeek}`,
              true
            );

            console.log("‚úÖ Week transition complete");
          } catch (error) {
            console.error("‚ùå Week transition error:", error);
            toast("Fout bij week overgang");
          }
        };

        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================

        const getAssignment = (task, week) => {
          if (!task || !task.assignedPeople) return null;
          const assigned = task.assignedPeople;
          if (assigned.length === 0) return null;
          if (assigned.length === 1) return assigned[0];
          const offset = config.rotationOffsets?.[task.id] || 0;
          const index = (week - 1 + offset) % assigned.length;
          return assigned[index];
        };

        const logActivity = async (user, action, task, status) => {
          const newActivity = [
            {
              user,
              action,
              task,
              status,
              timestamp: Date.now(),
              weekNumber: config.currentWeek,
            },
            ...activity,
          ].slice(0, ACTIVITY_LIMIT);
          await db.ref("activity").set(newActivity);
        };

        const toggleTask = async (taskId, isLastWeek = false) => {
          const tasks = isLastWeek ? lastTasks : currentTasks;
          const newStatus = !tasks[taskId];
          const newTasks = { ...tasks, [taskId]: newStatus };

          const ref = isLastWeek ? "lastWeekTasks" : "currentWeekTasks";
          await db.ref(ref).set(newTasks);

          const task = config.tasks.find((t) => t.id === taskId);
          const taskName = task?.name || taskId;

          // Handle late completion
          if (isLastWeek && newStatus) {
            const assignment = getAssignment(task, config.lastWeek);
            if (assignment && leaderboard[assignment]) {
              const latePoints = (task.points || 1.0) * 0.5;
              await db.ref(`leaderboard/${assignment}`).update({
                latePoints:
                  (leaderboard[assignment].latePoints || 0) + latePoints,
                totalPoints: leaderboard[assignment].totalPoints + latePoints,
              });
            }
            logActivity(user, "afgevinkt (te laat)", taskName, true);
          } else {
            // REAL-TIME LEADERBOARD UPDATE for current week tasks
            if (!isLastWeek) {
              const assignment = getAssignment(task, config.currentWeek);
              if (assignment) {
                const newLeaderboard = { ...leaderboard };
                if (!newLeaderboard[assignment]) {
                  newLeaderboard[assignment] = {
                    totalPoints: 0,
                    onTimePoints: 0,
                    latePoints: 0,
                    dishwasherPoints: 0,
                    dishwasherCount: 0,
                  };
                }

                const pointChange = (task.points || 1.0) * (newStatus ? 1 : -1);
                newLeaderboard[assignment].onTimePoints += pointChange;
                newLeaderboard[assignment].totalPoints += pointChange;

                await db.ref("leaderboard").set(newLeaderboard);
              }
            }

            logActivity(
              user,
              newStatus ? "afgevinkt" : "uitgevinkt",
              taskName,
              newStatus
            );
          }
        };

        const canEmptyDishwasher = () => {
          const today = now.toDateString();
          return !dishwasherLogs.some(
            (log) =>
              new Date(log.timestamp).toDateString() === today &&
              log.weekNumber === config.currentWeek
          );
        };

        const confirmDishwasher = async () => {
          const newLog = {
            user,
            timestamp: now.getTime(),
            weekNumber: config.currentWeek,
            points: config.dishwasherPoints || 0.25,
          };

          // Add to logs
          await db.ref("dishwasherLogs").set([...dishwasherLogs, newLog]);

          // Update leaderboard immediately
          const newLeaderboard = { ...leaderboard };
          if (!newLeaderboard[user]) {
            newLeaderboard[user] = {
              totalPoints: 0,
              onTimePoints: 0,
              latePoints: 0,
              dishwasherPoints: 0,
              dishwasherCount: 0,
            };
          }

          newLeaderboard[user].dishwasherPoints += config.dishwasherPoints;
          newLeaderboard[user].totalPoints += config.dishwasherPoints;
          newLeaderboard[user].dishwasherCount =
            dishwasherLogs.filter((log) => log.user === user).length + 1;

          await db.ref("leaderboard").set(newLeaderboard);

          logActivity(
            user,
            "leegde vaatwasser",
            `+${config.dishwasherPoints} punten`,
            true
          );
          setShowDishwasherConfirm(false);
        };

        // ============================================================================
        // RENDER
        // ============================================================================

        if (!user && config) {
          return (
            <UserPicker
              people={config.people}
              onSelect={(name) => {
                setUser(name);
                localStorage.setItem("currentUser", name);
              }}
            />
          );
        }

        if (loading || !config) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
              <div className="text-center">
                <div className="text-4xl mb-4">ü¶¢</div>
                <div className="text-gray-600">Laden...</div>
              </div>
            </div>
          );
        }

        const viewingLastWeek = view === "lastWeek";
        const tasks = viewingLastWeek ? lastTasks : currentTasks;
        const weekNumber = viewingLastWeek
          ? config.lastWeek
          : config.currentWeek;
        const isEditable =
          !viewingLastWeek || currentWeek - config.lastWeek <= 1;

        const completedCount =
          Object.values(currentTasks).filter(Boolean).length;
        const totalTasks = config.tasks.length;

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 pb-8">
            <div className="max-w-md mx-auto">
              {/* USER INDICATOR */}
              <div className="bg-white rounded-xl shadow-md p-3 mb-4 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-semibold text-sm">
                    {user.charAt(0)}
                  </div>
                  <span className="text-sm text-gray-600">
                    <span className="font-semibold text-gray-800">{user}</span>
                  </span>
                </div>
                <button
                  onClick={() => {
                    localStorage.removeItem("currentUser");
                    setUser("");
                  }}
                  className="text-xs text-blue-600 hover:text-blue-700"
                >
                  Wissel
                </button>
              </div>

              {/* TRACKER VIEW */}
              {view === "tracker" && (
                <>
                  {/* HEADER */}
                  <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <h1 className="text-2xl font-bold text-gray-800">
                          Schone Zwaan
                        </h1>
                        <p className="text-gray-600">
                          Week {config.currentWeek} ‚Ä¢{" "}
                          {getWeekDateRange(config.currentWeek, currentYear)}
                        </p>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => setView("leaderboard")}
                          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                          title="Leaderboard"
                        >
                          <Icons.Trophy size={20} className="text-gray-600" />
                        </button>
                        <button
                          onClick={() => setView("activity")}
                          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                          title="Activiteit"
                        >
                          <Icons.Activity size={20} className="text-gray-600" />
                        </button>
                        <button
                          onClick={() => setView("settings")}
                          className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                          title="Instellingen"
                        >
                          <Icons.Settings size={20} className="text-gray-600" />
                        </button>
                      </div>
                      {activity.status !== undefined && (
                        <div
                          className={`w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 ${
                            activity.status ? "bg-green-100" : "bg-gray-100"
                          }`}
                        >
                          {activity.status ? (
                            <Check size={14} className="text-green-600" />
                          ) : (
                            <X size={14} className="text-gray-400" />
                          )}
                        </div>
                      )}
                    </div>
                    <div className="mt-3 flex items-center gap-2">
                      <div className="flex-1 bg-gray-200 rounded-full h-2">
                        <div
                          className="bg-green-500 h-2 rounded-full transition-all"
                          style={{
                            width: `${
                              totalTasks > 0
                                ? (completedCount / totalTasks) * 100
                                : 0
                            }%`,
                          }}
                        />
                      </div>
                      <span className="text-sm font-medium text-gray-700">
                        {completedCount}/{totalTasks}
                      </span>
                    </div>
                  </div>

                  {/* DEADLINE BANNER */}
                  <div className="bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-orange-500 rounded-lg p-4 mb-4 flex items-center gap-3">
                    <Icons.Clock size={24} className="text-orange-600" />
                    <div className="flex-1">
                      <div className="font-semibold text-gray-800">
                        Deadline: Zondag{" "}
                        {(() => {
                          const sunday = new Date(now);
                          sunday.setDate(
                            now.getDate() + ((7 - now.getDay()) % 7)
                          );
                          return sunday.toLocaleDateString("nl-NL", {
                            day: "numeric",
                            month: "long",
                          });
                        })()}
                      </div>
                      <div className="text-sm text-gray-600">
                        {(() => {
                          const sunday = new Date(now);
                          sunday.setDate(
                            now.getDate() + ((7 - now.getDay()) % 7)
                          );
                          sunday.setHours(23, 59, 59, 999);
                          const diff = sunday - now;
                          const days = Math.floor(diff / 86400000);
                          const hours = Math.floor((diff % 86400000) / 3600000);
                          if (days >= 2) return `${days} dagen`;
                          if (days === 1) return "1 dag";
                          if (hours > 0) return `${hours} uur`;
                          return "Bijna voorbij!";
                        })()}{" "}
                        resterend
                      </div>
                    </div>
                  </div>

                  {/* LAST WEEK BANNER */}
                  {config.lastWeek && currentWeek - config.lastWeek <= 1 && (
                    <button
                      onClick={() => setView("lastWeek")}
                      className="w-full bg-orange-50 border-2 border-orange-300 rounded-xl p-4 mb-4 hover:bg-orange-100 transition-colors text-left"
                    >
                      <div className="font-semibold text-orange-800">
                        üìÖ Vorige Week (Week {config.lastWeek})
                      </div>
                      <div className="text-sm text-orange-600">
                        Klik om late taken af te vinken
                      </div>
                    </button>
                  )}

                  {/* DISHWASHER */}
                  <div className="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-4 mb-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">üçΩÔ∏è</div>
                        <div>
                          <div className="font-bold text-gray-800">
                            Vaatwasser
                          </div>
                          <div className="text-xs text-gray-600">
                            +{config.dishwasherPoints} punten
                          </div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-bold text-green-700">
                          {
                            dishwasherLogs.filter(
                              (l) => l.weekNumber === config.currentWeek
                            ).length
                          }
                          x
                        </div>
                        <div className="text-xs text-gray-600">deze week</div>
                      </div>
                    </div>
                    <button
                      onClick={() =>
                        canEmptyDishwasher() && setShowDishwasherConfirm(true)
                      }
                      disabled={!canEmptyDishwasher()}
                      className={`w-full p-3 rounded-lg font-semibold transition-all ${
                        canEmptyDishwasher()
                          ? "bg-blue-500 hover:bg-blue-600 text-white"
                          : "bg-gray-200 text-gray-500 cursor-not-allowed"
                      }`}
                    >
                      {canEmptyDishwasher()
                        ? "üçΩÔ∏è Vaatwasser geleegd?"
                        : "‚úì Al gedaan vandaag"}
                    </button>
                  </div>

                  {/* TASKS */}
                  <div className="space-y-3">
                    {config.tasks.map((task) => {
                      const isComplete = currentTasks[task.id];
                      const assignment = getAssignment(
                        task,
                        config.currentWeek
                      );
                      return (
                        <button
                          key={task.id}
                          onClick={() => toggleTask(task.id)}
                          className={`w-full p-5 rounded-xl shadow-md transition-all ${
                            isComplete
                              ? "bg-green-500 text-white"
                              : "bg-white text-gray-800 hover:shadow-lg"
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="text-left">
                              <div className="font-semibold text-lg">
                                {task.name}
                              </div>
                              <div className="flex items-center gap-2">
                                <span
                                  className={`text-sm ${
                                    isComplete
                                      ? "text-green-100"
                                      : "text-gray-600"
                                  }`}
                                >
                                  {assignment || "Niemand"}
                                </span>
                                <span
                                  className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                    isComplete
                                      ? "bg-green-200 text-green-800"
                                      : "bg-blue-100 text-blue-700"
                                  }`}
                                >
                                  {task.points || 1.0} pt
                                </span>
                              </div>
                            </div>
                            <div
                              className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                isComplete ? "bg-white" : "bg-gray-200"
                              }`}
                            >
                              {isComplete && (
                                <Icons.Check
                                  size={20}
                                  className="text-green-500"
                                />
                              )}
                            </div>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </>
              )}

              {/* LAST WEEK VIEW */}
              {view === "lastWeek" && (
                <>
                  <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => setView("tracker")}
                        className="p-2 hover:bg-gray-100 rounded-lg"
                      >
                        <Icons.ChevronLeft size={20} />
                      </button>
                      <div>
                        <h1 className="text-2xl font-bold text-gray-800">
                          Week {config.lastWeek}
                        </h1>
                        <p className="text-gray-600">
                          {getWeekDateRange(config.lastWeek, currentYear)} ‚Ä¢ Te
                          laat = 50% punten
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-3">
                    {config.tasks.map((task) => {
                      const isComplete = lastTasks[task.id];
                      const assignment = getAssignment(task, config.lastWeek);
                      const canToggle = !isComplete && isEditable;
                      return (
                        <button
                          key={task.id}
                          onClick={() => canToggle && toggleTask(task.id, true)}
                          disabled={!canToggle}
                          className={`w-full p-5 rounded-xl shadow-md transition-all ${
                            isComplete
                              ? "bg-yellow-500 text-white cursor-not-allowed"
                              : canToggle
                              ? "bg-white text-gray-800 hover:shadow-lg"
                              : "bg-gray-200 text-gray-500 cursor-not-allowed"
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="text-left">
                              <div className="font-semibold text-lg">
                                {task.name}
                              </div>
                              <div className="flex items-center gap-2">
                                <span
                                  className={`text-sm ${
                                    isComplete
                                      ? "text-yellow-100"
                                      : "text-gray-600"
                                  }`}
                                >
                                  {assignment || "Niemand"}{" "}
                                  {isComplete && "‚Ä¢ Te laat"}
                                </span>
                                <span
                                  className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                    isComplete
                                      ? "bg-yellow-200 text-yellow-800"
                                      : "bg-blue-100 text-blue-700"
                                  }`}
                                >
                                  {isComplete
                                    ? (task.points || 1.0) * 0.5
                                    : task.points || 1.0}{" "}
                                  pt
                                </span>
                              </div>
                            </div>
                            <div
                              className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                isComplete ? "bg-white" : "bg-gray-200"
                              }`}
                            >
                              {isComplete && (
                                <Icons.Check
                                  size={20}
                                  className="text-yellow-500"
                                />
                              )}
                            </div>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </>
              )}

              {/* LEADERBOARD VIEW */}
              {view === "leaderboard" && (
                <>
                  <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => setView("tracker")}
                        className="p-2 hover:bg-gray-100 rounded-lg"
                      >
                        <Icons.ChevronLeft size={20} />
                      </button>
                      <div>
                        <h1 className="text-2xl font-bold text-gray-800">
                          üèÜ Leaderboard
                        </h1>
                        <p className="text-gray-600">Wie is het schoonst?</p>
                      </div>
                    </div>
                  </div>

                  {(() => {
                    // Ensure all people are in leaderboard, even with 0 points
                    const fullLeaderboard = { ...leaderboard };
                    config.people.forEach((person) => {
                      if (!fullLeaderboard[person]) {
                        fullLeaderboard[person] = {
                          totalPoints: 0,
                          onTimePoints: 0,
                          latePoints: 0,
                          dishwasherPoints: 0,
                          dishwasherCount: 0,
                        };
                      }
                    });

                    const sorted = Object.entries(fullLeaderboard).sort(
                      ([, a], [, b]) =>
                        (b.totalPoints || 0) - (a.totalPoints || 0)
                    );

                    const top3 = sorted.slice(0, 3);
                    const rest = sorted.slice(3);

                    return (
                      <>
                        {/* PODIUM FOR TOP 3 */}
                        {top3.length > 0 && (
                          <div className="flex items-end justify-center gap-4 mb-8">
                            {/* 2nd Place */}
                            {top3[1] && (
                              <div className="flex-1 text-center">
                                <div className="bg-gradient-to-br from-gray-200 to-gray-300 rounded-2xl p-6 shadow-lg transform translate-y-8">
                                  <div className="text-5xl mb-2">ü¶¢</div>
                                  <div className="text-4xl font-bold text-gray-700 mb-1">
                                    2
                                  </div>
                                  <div className="font-bold text-gray-800 text-lg mb-1">
                                    {top3[1][0]}
                                  </div>
                                  <div className="text-2xl font-bold text-gray-700">
                                    {top3[1][1].totalPoints.toFixed(1)}
                                  </div>
                                  <div className="text-xs text-gray-600">
                                    punten
                                  </div>
                                  <div className="text-xs text-gray-600 mt-1">
                                    üçΩÔ∏è {top3[1][1].dishwasherCount || 0}x
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* 1st Place - SCHOONSTE ZWAAN */}
                            {top3[0] && (
                              <div className="flex-1 text-center">
                                <div className="bg-gradient-to-br from-yellow-300 via-yellow-400 to-yellow-500 rounded-2xl p-6 shadow-2xl relative">
                                  <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold shadow-lg">
                                    üëë Schoonste Zwaan
                                  </div>
                                  <div className="text-6xl mb-2 swan-bounce">
                                    ü¶¢
                                  </div>
                                  <div className="text-5xl font-bold text-yellow-900 mb-1">
                                    1
                                  </div>
                                  <div className="font-bold text-yellow-900 text-xl mb-1">
                                    {top3[0][0]}
                                  </div>
                                  <div className="text-3xl font-bold text-yellow-900">
                                    {top3[0][1].totalPoints.toFixed(1)}
                                  </div>
                                  <div className="text-sm text-yellow-800">
                                    punten
                                  </div>
                                  <div className="text-xs text-yellow-800 mt-1">
                                    üçΩÔ∏è {top3[0][1].dishwasherCount || 0}x
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* 3rd Place */}
                            {top3[2] && (
                              <div className="flex-1 text-center">
                                <div className="bg-gradient-to-br from-orange-200 to-orange-300 rounded-2xl p-6 shadow-lg transform translate-y-12">
                                  <div className="text-4xl mb-2">ü¶¢</div>
                                  <div className="text-3xl font-bold text-orange-700 mb-1">
                                    3
                                  </div>
                                  <div className="font-bold text-orange-800 text-lg mb-1">
                                    {top3[2][0]}
                                  </div>
                                  <div className="text-xl font-bold text-orange-700">
                                    {top3[2][1].totalPoints.toFixed(1)}
                                  </div>
                                  <div className="text-xs text-orange-600">
                                    punten
                                  </div>
                                  <div className="text-xs text-orange-600 mt-1">
                                    üçΩÔ∏è {top3[2][1].dishwasherCount || 0}x
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* REST OF RANKINGS */}
                        {rest.length > 0 && (
                          <div className="space-y-3 mt-16">
                            {rest.map(([name, data], index) => {
                              const isLast = index === rest.length - 1;
                              return (
                                <div
                                  key={name}
                                  className={`rounded-xl p-5 shadow-md transition-all ${
                                    isLast
                                      ? "bg-gradient-to-r from-amber-50 to-orange-100 border-2 border-amber-300"
                                      : "bg-white"
                                  }`}
                                >
                                  <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                      <div className="text-4xl">üêï</div>
                                      <div>
                                        {isLast && (
                                          <div className="text-xs font-bold text-amber-700 mb-1">
                                            Vieze Daggoe
                                          </div>
                                        )}
                                        <div className="font-bold text-xl text-gray-800">
                                          {name}
                                        </div>
                                        <div className="text-sm text-gray-500">
                                          #{index + 4} ‚Ä¢ üçΩÔ∏è{" "}
                                          {data.dishwasherCount || 0}x
                                        </div>
                                      </div>
                                    </div>
                                    <div className="text-right">
                                      <div className="text-3xl font-bold text-gray-800">
                                        {data.totalPoints.toFixed(1)}
                                      </div>
                                      <div className="text-xs text-gray-500">
                                        punten
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}

                        {/* INDIVIDUAL STATS CARD - Current User Only */}
                        {(() => {
                          const userData = fullLeaderboard[user];
                          if (!userData) return null;

                          return (
                            <div className="mt-8">
                              <h3 className="text-lg font-bold text-gray-800 mb-4">
                                üìä Mijn Punten
                              </h3>
                              <div className="bg-white rounded-xl shadow-md p-4">
                                <div className="grid grid-cols-3 gap-2">
                                  <div className="bg-green-50 rounded-lg p-2 text-center">
                                    <div className="text-xs text-green-600 font-medium mb-1">
                                      Op tijd
                                    </div>
                                    <div className="text-lg font-bold text-green-700">
                                      {(userData.onTimePoints || 0).toFixed(1)}
                                    </div>
                                  </div>

                                  <div className="bg-yellow-50 rounded-lg p-2 text-center">
                                    <div className="text-xs text-yellow-600 font-medium mb-1">
                                      Te laat
                                    </div>
                                    <div className="text-lg font-bold text-yellow-700">
                                      {(userData.latePoints || 0).toFixed(1)}
                                    </div>
                                  </div>

                                  <div className="bg-blue-50 rounded-lg p-2 text-center">
                                    <div className="text-xs text-blue-600 font-medium mb-1">
                                      üçΩÔ∏è Bonus
                                    </div>
                                    <div className="text-lg font-bold text-blue-700">
                                      {(userData.dishwasherPoints || 0).toFixed(
                                        1
                                      )}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })()}
                      </>
                    );
                  })()}
                </>
              )}

              {/* ACTIVITY VIEW */}
              {view === "activity" && (
                <>
                  <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => setView("tracker")}
                        className="p-2 hover:bg-gray-100 rounded-lg"
                      >
                        <Icons.ChevronLeft size={20} />
                      </button>
                      <div>
                        <h1 className="text-2xl font-bold text-gray-800">
                          üìä Activiteit
                        </h1>
                        <p className="text-gray-600">Recente acties</p>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-2">
                    {activity.map((act, i) => (
                      <div
                        key={i}
                        className="bg-white rounded-xl shadow-md p-4"
                      >
                        <div className="flex items-start gap-3">
                          <div className="w-8 h-8 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-semibold text-sm">
                            {act.user.charAt(0)}
                          </div>
                          <div className="flex-1">
                            <div className="text-sm">
                              <span className="font-semibold">{act.user}</span>
                              <span className="text-gray-600">
                                {" "}
                                {act.action}{" "}
                              </span>
                              <span className="font-medium">{act.task}</span>
                              <span className="text-gray-500">
                                {" "}
                                ‚Ä¢ Week {act.weekNumber}
                              </span>
                            </div>
                            <div className="text-xs text-gray-500 mt-1">
                              {formatTimestamp(act.timestamp)}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* 1st Place - SCHOONSTE ZWAAN */}
                  {leaderboard[0] && (
                    <div className="flex-1 text-center">
                      <div className="bg-gradient-to-br from-yellow-300 via-yellow-400 to-yellow-500 rounded-2xl p-6 shadow-2xl relative">
                        <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold shadow-lg">
                          üëë Schoonste Zwaan
                        </div>
                        <div className="text-6xl mb-2 animate-bounce">ü¶¢</div>
                        <div className="text-5xl font-bold text-yellow-900 mb-1">
                          1
                        </div>
                        <div className="font-bold text-yellow-900 text-xl mb-1">
                          {leaderboard[0].name}
                        </div>
                        <div className="text-3xl font-bold text-yellow-900">
                          {leaderboard[0].points % 1 === 0
                            ? leaderboard[0].points
                            : leaderboard[0].points.toFixed(2)}
                        </div>
                        <div className="text-sm text-yellow-800">punten</div>
                        {leaderboard[0].currentStreak > 0 && (
                          <div className="mt-2 text-orange-600 font-bold text-sm">
                            üî• {leaderboard[0].currentStreak}{" "}
                            {leaderboard[0].currentStreak === 1
                              ? "week"
                              : "weken"}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </>
              )}

              {/* SETTINGS VIEW */}
              {view === "settings" && (
                <SettingsView
                  config={config}
                  onBack={() => setView("tracker")}
                  currentWeek={config.currentWeek}
                  getAssignment={getAssignment}
                />
              )}

              {/* DISHWASHER CONFIRM */}
              <ConfirmDialog
                isOpen={showDishwasherConfirm}
                title="Is de vaat op het aanrecht ook ingeruimd?"
                message=""
                onConfirm={confirmDishwasher}
                onCancel={() => setShowDishwasherConfirm(false)}
                confirmText="Ja, bevestig"
                cancelText="Nee, annuleer"
              />
            </div>
          </div>
        );
      }

      // ============================================================================
      // SETTINGS VIEW
      // ============================================================================

      function SettingsView({ config, onBack, currentWeek, getAssignment }) {
        const [showAddPerson, setShowAddPerson] = useState(false);
        const [showAddTask, setShowAddTask] = useState(false);
        const [newPerson, setNewPerson] = useState("");
        const [newTask, setNewTask] = useState("");
        const [expandedTasks, setExpandedTasks] = useState({});

        const updateConfig = async (updates) => {
          await db.ref("config").update(updates);
        };

        const addPerson = async () => {
          if (!newPerson.trim() || config.people.includes(newPerson.trim()))
            return;
          await updateConfig({ people: [...config.people, newPerson.trim()] });
          setNewPerson("");
          setShowAddPerson(false);
        };

        const removePerson = async (person) => {
          const newTasks = config.tasks.map((t) => ({
            ...t,
            assignedPeople: t.assignedPeople.filter((p) => p !== person),
          }));
          await updateConfig({
            people: config.people.filter((p) => p !== person),
            tasks: newTasks,
          });
        };

        const addTask = async () => {
          if (!newTask.trim()) return;
          const id = newTask.toLowerCase().replace(/\s+/g, "_");
          await updateConfig({
            tasks: [
              ...config.tasks,
              { id, name: newTask.trim(), assignedPeople: [], points: 1.0 },
            ],
          });
          setNewTask("");
          setShowAddTask(false);
        };

        const removeTask = async (taskId) => {
          await updateConfig({
            tasks: config.tasks.filter((t) => t.id !== taskId),
          });
        };

        const updateTask = async (taskId, updates) => {
          const newTasks = config.tasks.map((t) =>
            t.id === taskId ? { ...t, ...updates } : t
          );
          await updateConfig({ tasks: newTasks });
        };

        const toggleTaskPerson = async (taskId, person) => {
          const task = config.tasks.find((t) => t.id === taskId);
          const assigned = task.assignedPeople.includes(person);
          const newAssigned = assigned
            ? task.assignedPeople.filter((p) => p !== person)
            : [...task.assignedPeople, person];
          await updateTask(taskId, { assignedPeople: newAssigned });
        };

        const changeRotation = async (taskId, person) => {
          const task = config.tasks.find((t) => t.id === taskId);
          const personIndex = task.assignedPeople.indexOf(person);
          const currentIndex = (currentWeek - 1) % task.assignedPeople.length;
          const newOffset = personIndex - currentIndex;
          await db.ref(`config/rotationOffsets/${taskId}`).set(newOffset);
        };

        return (
          <>
            <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
              <div className="flex items-center gap-3">
                <button
                  onClick={onBack}
                  className="p-2 hover:bg-gray-100 rounded-lg"
                >
                  <Icons.ChevronLeft size={20} />
                </button>
                <div>
                  <h1 className="text-2xl font-bold text-gray-800">
                    ‚öôÔ∏è Instellingen
                  </h1>
                  <p className="text-gray-600">Configuratie</p>
                </div>
              </div>
            </div>

            {/* PEOPLE */}
            <div className="bg-white rounded-xl shadow-md p-5 mb-4">
              <h3 className="font-semibold text-gray-700 mb-3">
                üë• Huisgenoten
              </h3>
              <div className="flex flex-wrap gap-2">
                {config.people.map((person) => (
                  <div
                    key={person}
                    className="inline-flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-medium"
                  >
                    <span>{person}</span>
                    <button
                      onClick={() => removePerson(person)}
                      className="hover:bg-blue-200 rounded-full p-0.5"
                    >
                      <Icons.X size={16} />
                    </button>
                  </div>
                ))}
                {showAddPerson ? (
                  <div className="inline-flex items-center gap-2 bg-green-100 px-3 py-2 rounded-full">
                    <input
                      type="text"
                      value={newPerson}
                      onChange={(e) => setNewPerson(e.target.value)}
                      onKeyPress={(e) => e.key === "Enter" && addPerson()}
                      placeholder="Naam..."
                      className="bg-transparent border-none outline-none w-24 text-sm"
                      autoFocus
                    />
                    <button
                      onClick={addPerson}
                      className="hover:bg-green-200 rounded-full p-0.5"
                    >
                      <Icons.Check size={16} />
                    </button>
                    <button
                      onClick={() => setShowAddPerson(false)}
                      className="hover:bg-green-200 rounded-full p-0.5"
                    >
                      <Icons.X size={16} />
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => setShowAddPerson(true)}
                    className="inline-flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-medium"
                  >
                    <Icons.Plus size={16} />
                  </button>
                )}
              </div>
            </div>

            {/* ROTATION */}
            <div className="bg-white rounded-xl shadow-md p-5 mb-4">
              <h3 className="font-semibold text-gray-700 mb-3">
                üë§ Wie doet wat deze week?
              </h3>
              <div className="space-y-3">
                {config.tasks.map((task) => (
                  <div
                    key={task.id}
                    className="border border-gray-200 rounded-lg p-3"
                  >
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      {task.name}
                    </label>
                    <div className="flex flex-wrap gap-2">
                      {task.assignedPeople.map((person) => (
                        <button
                          key={person}
                          onClick={() => changeRotation(task.id, person)}
                          className={`px-4 py-2 rounded-lg border-2 transition-all ${
                            getAssignment(task, currentWeek) === person
                              ? "border-blue-500 bg-blue-50 text-blue-700 font-medium"
                              : "border-gray-200 hover:border-gray-300 text-gray-700"
                          }`}
                        >
                          {person}
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* DISHWASHER POINTS */}
            <div className="bg-white rounded-xl shadow-md p-5 mb-4">
              <h3 className="font-semibold text-gray-700 mb-3">
                üçΩÔ∏è Vaatwasser Punten
              </h3>
              <div className="flex items-center gap-3">
                <input
                  type="number"
                  step="0.25"
                  min="0"
                  value={config.dishwasherPoints}
                  onChange={(e) =>
                    updateConfig({
                      dishwasherPoints: parseFloat(e.target.value) || 0.25,
                    })
                  }
                  className="w-32 px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold"
                />
                <span className="text-gray-600">punten</span>
              </div>
            </div>

            {/* TASKS */}
            <div className="bg-white rounded-xl shadow-md p-5 mb-4">
              <h3 className="font-semibold text-gray-700 mb-3">üìã Taken</h3>
              <div className="space-y-3">
                {config.tasks.map((task) => (
                  <div
                    key={task.id}
                    className="border-2 border-gray-200 rounded-xl overflow-hidden"
                  >
                    <div
                      onClick={() =>
                        setExpandedTasks({
                          ...expandedTasks,
                          [task.id]: !expandedTasks[task.id],
                        })
                      }
                      className="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50"
                    >
                      <div className="flex items-center gap-3">
                        {expandedTasks[task.id] ? (
                          <Icons.ChevronDown size={20} />
                        ) : (
                          <Icons.ChevronRight size={20} />
                        )}
                        <span className="font-semibold">{task.name}</span>
                        <span className="text-xs text-gray-500">
                          ({task.points || 1.0} pt)
                        </span>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          removeTask(task.id);
                        }}
                        className="p-2 hover:bg-red-50 rounded-lg text-red-600"
                      >
                        <Icons.X size={18} />
                      </button>
                    </div>
                    {expandedTasks[task.id] && (
                      <div className="p-4 border-t bg-gray-50">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Punten
                        </label>
                        <input
                          type="number"
                          step="0.25"
                          min="0"
                          value={task.points || 1.0}
                          onChange={(e) =>
                            updateTask(task.id, {
                              points: parseFloat(e.target.value) || 1.0,
                            })
                          }
                          className="w-24 px-3 py-2 border border-gray-300 rounded-lg mb-3"
                        />
                        <p className="text-sm font-medium text-gray-700 mb-2">
                          Wie kan dit doen?
                        </p>
                        <div className="flex flex-wrap gap-2">
                          {config.people.map((person) => (
                            <button
                              key={person}
                              onClick={() => toggleTaskPerson(task.id, person)}
                              className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                                task.assignedPeople.includes(person)
                                  ? "bg-green-100 text-green-700 hover:bg-green-200"
                                  : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                              }`}
                            >
                              {task.assignedPeople.includes(person)
                                ? "‚úì "
                                : "+ "}
                              {person}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
                {showAddTask ? (
                  <div className="border-2 border-dashed border-green-300 rounded-xl p-4 bg-green-50">
                    <input
                      type="text"
                      value={newTask}
                      onChange={(e) => setNewTask(e.target.value)}
                      onKeyPress={(e) => e.key === "Enter" && addTask()}
                      placeholder="Taak naam..."
                      className="w-full px-3 py-2 border border-green-300 rounded-lg mb-2"
                      autoFocus
                    />
                    <div className="flex gap-2">
                      <button
                        onClick={addTask}
                        className="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium"
                      >
                        Toevoegen
                      </button>
                      <button
                        onClick={() => setShowAddTask(false)}
                        className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium"
                      >
                        Annuleer
                      </button>
                    </div>
                  </div>
                ) : (
                  <button
                    onClick={() => setShowAddTask(true)}
                    className="w-full border-2 border-dashed border-gray-300 hover:border-blue-400 hover:bg-blue-50 rounded-xl p-4 text-gray-600 hover:text-blue-600 font-medium flex items-center justify-center gap-2"
                  >
                    <Icons.Plus size={20} />
                    Nieuwe Taak
                  </button>
                )}
              </div>
            </div>
          </>
        );
      }

      // ============================================================================
      // INIT
      // ============================================================================

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
